<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WASM-4 and Zig</title>
  <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/base-min.css">
  <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/pure-min.css" integrity="sha384-cg6SkqEOCV1NbJoCu11+bm0NvBRc8IYLRGXkmNrqUBfTjmMYwNKPWBTIKyw9mHNJ" crossorigin="anonymous">
  <link rel="stylesheet" href="https://unpkg.com/purecss@2.0.3/build/grids-responsive-min.css">

  <script src="https://kit.fontawesome.com/b038bb8731.js" crossorigin="anonymous"></script>

  <link rel="alternate" title="JO Jaeyoung" type="application/feed+json" href="https://jaese.github.io/feed.json" />

  
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "WASM-4 and Zig",
  
  "datePublished": "2021-11-15T02:34:44+09:00",
  "dateModified": "2021-11-15T02:34:44+09:00",
  "author": {
    "@type": "Person",
    "url": "https://jaese.github.io/",
    "name": "jaese"
  },
  "mainEntityOfPage": { "@type": "Webpage" },
  "description": "WASM-4 binaries running on browser  *Fancy* graphics   Press R to reset     .wasm4 { padding: 10px; box-sizing: border-box; } #rotating_cube { width: 320px; height: 320px; } #rotating_cube canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; } #snake { width: 320px; height: 320px; } #snake canvas { width: 100%; height: 100%; image-rendering: pixelated; image-rendering: crisp-edges; }  import { run } from \"",
  "keywords": [
    
    
    "wasm-4"
    
    ,
    
    "webassembly"
    
  ]
}
</script>


</head>

<body>
  <style>
    body {
      margin: 0;
    }

     
  </style>

  <div class="wrap pure-g">
    <nav class="profile pure-u-1 pure-u-md-1-4">
      <h3><a href="/">JO Jaeyoung<br>조재영</a></h3>
      <img class="pure-img" style="width:60%" src="/profile.png" />

      <ul>
        <li><a href="https://jaese.github.io/feed.json"><i class="fas fa-rss-square"></i> JSON Feed</a></li>
        <li><a href="https://github.com/jaese"><i class="fab fa-github"></i> GitHub</a></li>
        <li><a href="https://www.kaggle.com/jaeyoungse"><i class="fab fa-kaggle"></i> Kaggle</a></li>
        <li><a href="https://www.linkedin.com/in/jaeyoung-jo-64b2a6148/"><i class="fab fa-linkedin"></i> LinkedIn</a></li>
        <li><a href="https://www.instagram.com/jaeyoung.se/"><i class="fab fa-instagram"></i> Instagram</a></li>
        <li><a href="mailto:jojaeyoung.se@gmail.com"><i class="fas fa-envelope-square"></i> Email</a></li>
        <li><a href="https://keybase.io/jaese"><i class="fab fa-keybase"></i> Keybase</a></li>
        <li><a href="gemini://jaeyoung.se"><i class="fas fa-rocket"></i> Gemini Capsule</a></li>
      </ul>

      <p>
        My role model is Iron Man.
      </p>

      <p class="time">
        UTC - TAI =<br><a href="https://hpiers.obspm.fr/iers/bul/bulc/bulletinc.dat">-37 s</a>
        <br>
        <br>
        TIME_TAI = <span class="time-tai">?</span>
        <br>
        (based on browser time)
      </p>

      
    </nav>
    <div class="content pure-u-1 pure-u-md-3-4">
      
<main>
  <article>
    <h1>WASM-4 and Zig</h1>
    <div>
      <time datetime="2021-11-15T02:34:44">2021-11-15T02:34:44</time>
      <p>tags: [wasm-4 webassembly]</p>
    </div>
    <div class="content">
      
      
      <div>
  <div style="text-align: center;">WASM-4 binaries running on browser</div>
  <div class="pure-g">
    <div class="pure-u-1 pure-u-md-1-2 wasm4">
      <div id="rotating_cube"></div>
      <caption>*Fancy* graphics</caption>
    </div>

    <div class="pure-u-1 pure-u-md-1-2 wasm4">
      <div id="snake"></div>
      <caption>Press R to reset</caption>
    </div>
  </div>
</div>
<style>
  .wasm4 {
    padding: 10px;
    box-sizing: border-box;
  }

  #rotating_cube {
    width: 320px;
    height: 320px;
  }

  #rotating_cube canvas {
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }

  #snake {
    width: 320px;
    height: 320px;
  }

  #snake canvas {
    width: 100%;
    height: 100%;
    image-rendering: pixelated;
    image-rendering: crisp-edges;
  }
</style>

<script type="module">
  import { run } from "/wasm4.js";

  run("rotating_cube", "/graphics.wasm", false);
  run("snake", "/snake.wasm", true);
</script>
<p>Lately I&rsquo;ve been into <a href="https://webassembly.org/">WebAssembly</a>. I am confident that WebAssembly will resolutionize the software industry. The way I see, as a backend operator, is that it will be like how Docker changed the way backend software is delivered and operated, but at a larger scope. Instead, the effect of WebAssembly will span many more types of software, from data pipelines to mobile clients.</p>
<p>Docker operationalized the backend software delivery. Before Docker, I had to deal with tarballs, jar files, war files, and other different and incompatible formats. After Docker, it was just Docker image, and often times I did not have to go deeper than that. It is a solid baseline. What I imagine is, in the future, wasm binaries will be the standard unit of software. When someone hands you a piece of software, it would often be in the wasm format, because, unlike other existing types of libraries and executables, wasm is standardized with clear and portable semantics, and I&rsquo;m not aware of anything that is like.</p>
<p>So, I wanted to try my hands on writing a wasm program. I picked up a book<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> and followed the tutorials to learn how it worked. <a href="https://webassembly.github.io/spec/core/">The core spec</a> is surprisingly minimal, almost bare. It was surprising because wasm binaries run at a near native speed, I did not know that can be achieved by such minimal architecture.</p>
<p>Concurrently, I started learning <a href="https://ziglang.org/">the Zig language</a>, because I wanted to write wasm codes in Zig. Rust seemed like a natural choice as it was most well supported, but a few lines of Rust code are enough to bankrupt my brain capacity, so no Rust. Also, I do not like C, it is a work language, not a hobby language. So learning another new niche language it is then, and it was worth it. Zig is a very well designed language, and especially I was blown away by its Comptime feature. Even though it is still in development phase, using it was without much difficulty, at least for my purposes.</p>
<p>And this weekend the two came together and I made those wasm thingies that can be seen on this page, written in Zig. A wasm binary by itself is just functions and it needs a host platform to do I/O, but I was too lazy to hook up APIs together myself. So I used the WebAssembly-based fantasy console called <a href="https://wasm4.org/">WASM-4</a> to make it display prettily on web. The WASM-4 documentation is really easy to follow, thanks to @DaVyze.</p>
<p>The Zig code for the WASM-4 snake is here: <a href="https://github.com/jaese/wasm4-snake-zig">https://github.com/jaese/wasm4-snake-zig</a></p>
<p>I wrote a set of rudimentary matrix routines in Zig to make the rotating cube. I adapted the style of <a href="https://pkg.go.dev/gonum.org/v1/gonum/mat">https://pkg.go.dev/gonum.org/v1/gonum/mat</a> and I think it works OK in Zig. Here is the part that rotates, using the matrix routines (note: I don&rsquo;t know how math):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zig" data-lang="zig"><span style="color:#75715e">// Params:
</span><span style="color:#75715e">//  vs: (None, 3) Matrix - vertices
</span><span style="color:#75715e">//  theta: radians - rotation
</span><span style="color:#75715e">//  axis: (3) Vec - axis of rotation
</span><span style="color:#75715e"></span><span style="color:#66d9ef">fn</span> rotate(dst<span style="color:#f92672">:</span> mat.Dense, vs<span style="color:#f92672">:</span> anytype, theta<span style="color:#f92672">:</span> <span style="color:#66d9ef">f32</span>, axis<span style="color:#f92672">:</span> anytype) <span style="color:#66d9ef">void</span> {
    assert(dst.rows() <span style="color:#f92672">==</span> vs.rows());
    assert(dst.cols() <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>);
    assert(vs.cols() <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>);

    <span style="color:#75715e">// q = quaternion.rotation(theta, axis[0], axis[1], axis[2])
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">const</span> q <span style="color:#f92672">=</span> quaternion.rotation(theta, axis.atVec(<span style="color:#ae81ff">0</span>), axis.atVec(<span style="color:#ae81ff">1</span>), axis.atVec(<span style="color:#ae81ff">2</span>));

    <span style="color:#75715e">// m = quaternion.mat_left(q)
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> m_arr <span style="color:#f92672">=</span> quaternion.matLeft(q);
    <span style="color:#66d9ef">const</span> m <span style="color:#f92672">=</span> mat.Dense.init(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>m_arr);

    <span style="color:#75715e">// m_inv = quaternion.mat_right(quaternion.inverse(q))
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> m_inv_arr <span style="color:#f92672">=</span> quaternion.matRight(quaternion.inverse(q));
    <span style="color:#66d9ef">const</span> m_inv <span style="color:#f92672">=</span> mat.Dense.init(<span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>, <span style="color:#f92672">&amp;</span>m_inv_arr);

    <span style="color:#75715e">// x_p = jnp.vstack((jnp.zeros((1, x.shape[0])), x.T))
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> vs_p_arr <span style="color:#f92672">=</span> allocator.alloc(<span style="color:#66d9ef">f32</span>, <span style="color:#ae81ff">4</span> <span style="color:#f92672">*</span> vs.rows()) <span style="color:#66d9ef">catch</span> <span style="color:#66d9ef">unreachable</span>;
    <span style="color:#66d9ef">defer</span> allocator.free(vs_p_arr);
    <span style="color:#66d9ef">const</span> vs_p <span style="color:#f92672">=</span> mat.denseStackOf(vs_p_arr, mat.Zeros{ .r <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, .c <span style="color:#f92672">=</span> vs.rows() }, vs.transpose());

    <span style="color:#75715e">// x_p = (m_inv.T @ (m @ x_p))
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">var</span> scratch<span style="color:#f92672">:</span> [<span style="color:#ae81ff">4</span>]<span style="color:#66d9ef">f32</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">undefined</span>;
    vs_p.mulLeft(<span style="color:#f92672">&amp;</span>scratch, m);
    vs_p.mulLeft(<span style="color:#f92672">&amp;</span>scratch, m_inv.transpose());

    <span style="color:#75715e">// return x_p[1:, :].T
</span><span style="color:#75715e"></span>    dst.copy(vs_p.slice(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">0</span>, vs_p.cols()).transpose());
}
</code></pre></div><p>End.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p><a href="https://learning.oreilly.com/library/view/the-art-of/9781098128982/">https://learning.oreilly.com/library/view/the-art-of/9781098128982/</a> &ldquo;The Art of WebAssembly by Rick Battagline&rdquo;&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </div>
    <style>
      .content p {
        line-height: 130%;
      }

      pre {
        padding: 1rem;
      }
    </style>
  </article>
  
</main>

<script src="https://giscus.app/client.js"
        data-repo="jaese/jaese.github.io"
        data-repo-id="R_kgDOGU2PdQ"
        data-category="Announcements"
        data-category-id="DIC_kwDOGU2Pdc4CA-sN"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>



    </div>
  </div>
  <style>
    nav.profile {
      display: flex;
      flex-direction: column;
      align-items: center;
      max-width: 200px;
      margin-right: 15px;
       

      box-sizing: border-box;
    }

    nav.profile ul {
      list-style: none;
      width: 100%;
    }

    nav.profile li {
      line-height: 20px;
    }
    nav.profile .fab, .fas {
      width: 15px;
    }
    nav.profile a {
      color: #333333;
      text-decoration: none;
    }

    .time {
      text-align: center;
    }
    .time a {
      font-weight: bold;
    }

    div.content {
      max-width: 800px;
       

      box-sizing: border-box;
    }

 
  </style>



  <script type="module">
    const timeTAIElement = document.querySelector('.time-tai');
    const utcTAIOffset = -37;

    const updateTime = () => {
      const local = new Date();
      const utc = new Date(local.getTime() + local.getTimezoneOffset() * 60 * 1000);
      const tai = utc.getTime() - (utcTAIOffset * 1000);
      timeTAIElement.textContent = Math.round(tai / 1000);

      let ms = local.getTime() % 1000;
      if (ms > 500) {
        ms -= 1000;
      };
      
    };
    updateTime();

  </script>
</body>

</html>
